<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Portal KARTEJI • Cilosari Barat</title>
<link rel="icon" href="assets/logo.svg" />
<style>
:root{
  --biru:#0e4c92;--biru2:#1a6ac2;--emas:#f6c445;
  --bg:#0b132b;--text:#f5f7fa;--card:#111928;--line:rgba(255,255,255,.1);
}
body.light{--bg:#f5f7fa;--text:#1e293b;--card:#fff;--line:rgba(0,0,0,.1);}
*{box-sizing:border-box;transition:background .3s,color .3s;}
body{margin:0;font-family:'Poppins',system-ui;background:var(--bg);color:var(--text);}
a{text-decoration:none;color:inherit;}
header{display:flex;align-items:center;justify-content:space-between;padding:.9rem 1.2rem;
  position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--line);z-index:20;}
.brand{display:flex;align-items:center;gap:.6rem;}
.brand img{width:42px;height:42px;}
nav{display:flex;gap:1rem;align-items:center;flex-wrap:wrap;}
nav a,nav span{font-weight:600;}
.btn{padding:.55rem 1rem;border-radius:10px;font-weight:700;border:none;cursor:pointer;}
.btn-primary{background:var(--emas);color:#0b132b;}
.btn-outline{background:transparent;border:1px solid var(--emas);color:var(--emas);}
.hero{padding:4rem 1rem;text-align:center;max-width:720px;margin:auto;}
.hero h1{font-size:2rem;color:var(--emas);}
.hero p{font-size:1.05rem;line-height:1.6;color:var(--text);}
.section{padding:2rem 1rem;max-width:900px;margin:auto;}
.section h2{text-align:center;color:var(--emas);}
.item{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:1rem;margin:.6rem 0;}
.item img{width:100%;border-radius:10px;margin:.5rem 0;}
footer{text-align:center;padding:2rem 1rem;border-top:1px solid var(--line);color:var(--text);}
#themeBtn{background:transparent;border:none;color:inherit;cursor:pointer;font-size:1rem;}
.fade-in{opacity:0;transform:translateY(20px);animation:fadeIn .8s forwards;}
@keyframes fadeIn{to{opacity:1;transform:translateY(0)}}
.hidden{display:none;}
.muted{color:rgba(255,255,255,.6);}
body.light .muted{color:#64748b;}
.poinBox{background:var(--card);padding:.4rem .8rem;border-radius:10px;border:1px solid var(--line);font-size:.9rem;}
.kegiatan-grid{display:grid;gap:1rem;}
@media(min-width:700px){.kegiatan-grid{grid-template-columns:repeat(2,1fr)}}
.kegiatan-item{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:1rem;}
.kegiatan-item img{width:100%;border-radius:10px;margin-bottom:.5rem;}
</style>
</head>
<body>
<header>
  <div class="brand fade-in">
    <img src="assets/logo.svg" alt="Logo KARTEJI">
    <b>KARTEJI Portal</b>
  </div>
  <nav class="fade-in" style="animation-delay:.3s;">
    <a href="#kegiatan">Kegiatan</a>
    <a href="#berita">Berita</a>
    <a href="#pengumuman">Pengumuman</a>
    <button id="themeBtn">🌓</button>
    <span id="userName" class="hidden"></span>
    <span id="poinUser" class="poinBox hidden">🏅 0 pts</span>
    <a id="loginBtn" href="auth.html" class="btn btn-primary">Masuk / Daftar</a>
    <a id="dashBtn" href="dashboard.html" class="btn btn-outline hidden">Dashboard</a>
    <button id="logoutBtn" class="btn btn-outline hidden">Keluar</button>
  </nav>
</header>

<section class="hero fade-in" style="animation-delay:.4s;">
  <h1>Portal Digital Karang Taruna<br/>Cilosari Barat RT01/RW08</h1>
  <p>
    💪 Melihat program pelatihan, lomba, dan kegiatan sosial.<br>
    💰 Mengakses informasi kas dan iuran anggota.<br>
    🧠 Belajar bersama lewat konten edukatif dan inspiratif.<br>
    🏅 Mengumpulkan poin & lencana keaktifan sebagai bentuk apresiasi.
  </p>
  <a href="auth.html" class="btn btn-primary" id="ctaBtn">🚀 Mulai Sekarang</a>
</section>

<!-- === KEGIATAN === -->
<section id="kegiatan" class="section fade-in" style="animation-delay:.55s;">
  <h2>💪 Kegiatan Terbaru</h2>
  <div id="kegiatanList" class="kegiatan-grid"></div>
</section>

<!-- === BERITA === -->
<section id="berita" class="section fade-in" style="animation-delay:.7s;">
  <h2>📰 Berita Terbaru</h2>
  <div id="beritaList"></div>
</section>

<!-- === PENGUMUMAN === -->
<section id="pengumuman" class="section fade-in" style="animation-delay:.9s;">
  <h2>📢 Pengumuman</h2>
  <div id="pengumumanList"></div>
</section>

<!-- === KAS (login only) === -->
<section id="kas" class="section fade-in hidden" style="animation-delay:1.1s;">
  <h2>💰 Kas RT / Karang Taruna</h2>
  <div id="kasRingkasan" class="item muted">Memuat...</div>
</section>

<section id="tentang" class="section fade-in" style="animation-delay:1.3s;">
  <h2>Tentang KARTEJI</h2>
  <p>KARTEJI (Karang Taruna Cilosari Barat) adalah wadah generasi muda untuk berkreasi, 
  berwirausaha, dan berkontribusi bagi lingkungan.</p>
</section>

<footer class="fade-in" style="animation-delay:1.5s;">
  <p>© 2025 KARTEJI Cilosari Barat · Dibuat dengan 💙 Semarang</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { getFirestore, collection, getDocs, query, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCgJC8OQBG_wQt57tZHfNuVKPb2VVlAalI",
  authDomain: "karang-taruna-aadaf.firebaseapp.com",
  projectId: "karang-taruna-aadaf",
  storageBucket: "karang-taruna-aadaf.appspot.com",
  messagingSenderId: "367208001887",
  appId: "1:367208001887:web:bce5982d99edefb7e746ea"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// UI refs
const themeBtn=document.getElementById('themeBtn');
const loginBtn=document.getElementById('loginBtn');
const dashBtn=document.getElementById('dashBtn');
const logoutBtn=document.getElementById('logoutBtn');
const ctaBtn=document.getElementById('ctaBtn');
const userName=document.getElementById('userName');
const poinUser=document.getElementById('poinUser');
const kasSection=document.getElementById('kas');

// Tema toggle
themeBtn.onclick=()=>document.body.classList.toggle('light');

// === LOAD DATA ===
async function loadKegiatan(){
  const snap=await getDocs(query(collection(db,'kegiatan'),orderBy('createdAt','desc')));
  const c=document.getElementById('kegiatanList');
  c.innerHTML='';
  if(snap.empty){c.innerHTML='<p class="muted">Belum ada kegiatan.</p>';return;}
  snap.forEach(d=>{
    const k=d.data(), id=d.id;
    const foto=Array.isArray(k.foto)?k.foto[0]:k.foto;
    const el=document.createElement('div');
    el.className='kegiatan-item';
    el.innerHTML=`
      ${foto?`<img src="${foto}" alt="">`:''}
      <b>${k.judul||'(Tanpa judul)'}</b><br>
      <small class="muted">${k.tanggal||''} · ${k.tipe||''}</small>
      <p>${(k.deskripsi||'').slice(0,120)}${k.deskripsi&&k.deskripsi.length>120?'…':''}</p>`;
    c.appendChild(el);
  });
}

async function loadBerita(){
  const snap=await getDocs(query(collection(db,'berita'),orderBy('createdAt','desc')));
  const c=document.getElementById('beritaList');
  c.innerHTML='';
  if(snap.empty){c.innerHTML='<p class="muted">Belum ada berita.</p>';return;}
  snap.forEach(d=>{
    const b=d.data(), id=d.id;
    const foto=Array.isArray(b.foto)?b.foto[0]:b.foto;
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML=`<a href="berita.html?id=${id}" style="text-decoration:none;color:inherit;">
      ${foto?`<img src="${foto}" alt="">`:''}
      <b>${b.judul||'(Tanpa judul)'}</b>
      <p>${(b.isi||'').slice(0,180)}${b.isi&&b.isi.length>180?'…':''}</p>
    </a>`;
    c.appendChild(el);
  });
}

async function loadPengumuman(){
  const snap=await getDocs(query(collection(db,'pengumuman'),orderBy('createdAt','desc')));
  const c=document.getElementById('pengumumanList');
  c.innerHTML='';
  if(snap.empty){c.innerHTML='<p class="muted">Belum ada pengumuman.</p>';return;}
  snap.forEach(d=>{
    const p=d.data();
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML=`<b>${p.judul||'(Tanpa judul)'}</b><p>${(p.isi||'').slice(0,180)}${p.isi&&p.isi.length>180?'…':''}</p>`;
    c.appendChild(el);
  });
}

async function loadKas(){
  const snap=await getDocs(collection(db,'kas'));
  let masuk=0,keluar=0;
  snap.forEach(d=>{
    const k=d.data();
    if(k.tipe==='masuk') masuk+=Number(k.jumlah||0);
    else keluar+=Number(k.jumlah||0);
  });
  const total=masuk-keluar;
  document.getElementById('kasRingkasan').innerHTML=`💸 Total Kas Saat Ini: <b>Rp ${total.toLocaleString('id-ID')}</b>`;
}

// === LOGIN CHECK ===
onAuthStateChanged(auth, async (user)=>{
  if(user){
    const name=user.displayName||user.email;
    userName.textContent=`👋 ${name}`;
    userName.classList.remove('hidden');
    loginBtn.classList.add('hidden');
    logoutBtn.classList.remove('hidden');
    dashBtn.classList.remove('hidden');
    kasSection.classList.remove('hidden');
    ctaBtn.textContent="🏠 Buka Dashboard";
    ctaBtn.href="dashboard.html";
    // ambil poin user
    const userRef=doc(db,'users',user.uid);
    const snap=await getDoc(userRef);
    if(snap.exists()){
      const data=snap.data();
      poinUser.textContent=`🏅 ${data.poin||0} pts`;
      poinUser.classList.remove('hidden');
    }
    loadKas();
  }else{
    userName.classList.add('hidden');
    poinUser.classList.add('hidden');
    loginBtn.classList.remove('hidden');
    logoutBtn.classList.add('hidden');
    dashBtn.classList.add('hidden');
    kasSection.classList.add('hidden');
    ctaBtn.textContent="🚀 Mulai Sekarang";
    ctaBtn.href="auth.html";
  }
  loadKegiatan();
  loadBerita();
  loadPengumuman();
});

logoutBtn.onclick=()=>signOut(auth).then(()=>location.reload());
</script>
</body>
</html>