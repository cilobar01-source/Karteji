<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="assets/logo.svg">
<link rel="stylesheet" href="css/style.css">
<title>Portal Karang Taruna Cilosari Barat</title>
</head>
<body>
<header class="card" style="border-radius:0">
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;">
    <div class="brand">
      <img src="assets/logo.svg" alt="logo">
      <div class="brand-title">KARTEJI • Cilosari Barat RT01/RW08</div>
    </div>
    <div class="hamburger" id="hamb"><span></span><span></span><span></span></div>
    <nav class="nav">
      <div class="nav-links" id="navLinks">
        <a href="#pengumuman">Pengumuman</a>
        <a href="#berita">Berita</a>
        <a href="#umkm">Produk</a>
        <a href="#kas">Ringkasan Kas</a>
      </div>
      <div class="nav-auth" id="navAuth">
        <!-- diisi dinamis -->
      </div>
    </nav>
  </div>
</header>

<section class="hero">
  <div class="container">
    <div class="card">
      <div class="pad">
        <h2 style="margin:.2rem 0 0 0;color:#fff">Selamat Datang di Portal Karang Taruna</h2>
        <p class="note">Kemijen, Semarang Timur — informasi terkini pengumuman, berita, produk/UMKM dan ringkasan kas.</p>
      </div>
    </div>
  </div>
</section>

<main class="container">
  <!-- Pengumuman -->
  <section id="pengumuman" class="card"><div class="pad">
    <h3 class="section-title">📢 Pengumuman</h3>
    <div id="pengList" class="grid grid-2"></div>
    <p class="note" id="pengEmpty" style="display:none">Belum ada pengumuman.</p>
  </div></section>

  <!-- Berita -->
  <section id="berita" class="card" style="margin-top:1rem"><div class="pad">
    <h3 class="section-title">📰 Berita</h3>
    <div id="beritaList" class="grid grid-3"></div>
    <p class="note" id="beritaEmpty" style="display:none">Belum ada berita.</p>
  </div></section>

  <!-- UMKM / Produk -->
  <section id="umkm" class="card" style="margin-top:1rem"><div class="pad">
    <h3 class="section-title">🏪 Produk</h3>
    <div id="umkmList" class="grid grid-3"></div>
    <p class="note" id="umkmEmpty" style="display:none">Belum ada produk.</p>
  </div></section>

  <!-- Kas -->
  <section id="kas" class="card" style="margin-top:1rem"><div class="pad">
    <h3 class="section-title">💰 Ringkasan Kas</h3>
    <div class="badge">Total Saat Ini</div>
    <h2 id="kasTotal" style="margin:.3rem 0 0 0">Rp 0</h2>
    <p class="note">Detail transaksi hanya untuk anggota — buka Dashboard.</p>
  </div></section>
</main>

<footer>
  © 2025 Karang Taruna Cilosari Barat RT01/RW08 • Kemijen, Semarang Timur
</footer>

<script type="module">
import { db, auth } from './js/firebase.js';
import { onAuth, logout } from './js/auth.js';
import { $, truncate } from './js/utils.js';
import {
  collection, getDocs, orderBy, query
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

/* hamburger */
const hamb = $('#hamb'), navLinks = $('#navLinks');
if(hamb) hamb.addEventListener('click', ()=> navLinks.classList.toggle('open'));

/* auth navbar */
const navAuth = $('#navAuth');
onAuth(async(user)=>{
  if(user){
    navAuth.innerHTML = `
      <a href="dashboard.html" class="btn btn-primary">Dashboard</a>
      <button class="btn btn-ghost" id="logoutBtn">Keluar</button>
    `;
    $('#logoutBtn')?.addEventListener('click', async()=>{ await logout(); location.reload(); });
  } else {
    navAuth.innerHTML = `
      <a href="login.html" class="btn btn-primary">Masuk</a>
      <a href="register.html" class="btn btn-ghost">Daftar</a>
    `;
  }
});

/* load pengumuman */
(async ()=>{
  const list = $('#pengList'); const empty = $('#pengEmpty');
  const snap=await getDocs(query(collection(db,'pengumuman'),orderBy('createdAt','desc')));
  list.innerHTML="";
  if(snap.empty){ empty.style.display='block'; return; }
  snap.forEach(d=>{
    const p=d.data();
    const el=document.createElement('div');
    el.className='card'; el.innerHTML=`
      <div class="pad">
        <div class="badge">${p.tanggal||''}</div>
        <h4 style="margin:.4rem 0">${p.judul||'(Tanpa judul)'}</h4>
        <p style="white-space:pre-line">${truncate(p.isi||'', 180)}</p>
        <a class="btn btn-ghost" href="dashboard.html#pengumuman">Selengkapnya</a>
      </div>`;
    list.appendChild(el);
  });
})();

/* load berita */
(async ()=>{
  const list = $('#beritaList'); const empty = $('#beritaEmpty');
  const snap=await getDocs(query(collection(db,'berita'),orderBy('createdAt','desc')));
  list.innerHTML="";
  if(snap.empty){ empty.style.display='block'; return; }
  snap.forEach(d=>{
    const b=d.data(); const img = Array.isArray(b.foto)? b.foto[0] : b.foto;
    const el=document.createElement('div');
    el.className='card'; el.innerHTML=`
      ${img?`<img class="thumb" src="${img}" alt="">`:''}
      <div class="pad">
        <h4 style="margin:.4rem 0">${b.judul||'(Tanpa judul)'}</h4>
        <p>${truncate(b.isi||'',150)}</p>
        <a class="btn btn-ghost" href="dashboard.html#berita">Selengkapnya</a>
      </div>`;
    list.appendChild(el);
  });
})();

/* load umkm */
(async ()=>{
  const list = $('#umkmList'); const empty = $('#umkmEmpty');
  const snap=await getDocs(query(collection(db,'umkm'),orderBy('createdAt','desc')));
  list.innerHTML="";
  if(snap.empty){ empty.style.display='block'; return; }
  snap.forEach(d=>{
    const u=d.data(); const img = Array.isArray(u.foto)? u.foto[0] : u.foto;
    const el=document.createElement('div');
    el.className='card'; el.innerHTML=`
      ${img?`<img class="thumb" src="${img}" alt="">`:''}
      <div class="pad">
        <h4 style="margin:.4rem 0">${u.produk||'(Produk)'}</h4>
        <p>👤 ${u.penjual||'-'} • 💰 Rp${(u.harga||0).toLocaleString('id-ID')}</p>
        ${u.wa?`<a class="btn btn-primary" target="_blank" href="https://wa.me/${u.wa}">Hubungi</a>`:''}
      </div>`;
    list.appendChild(el);
  });
})();

/* ringkasan kas */
(async ()=>{
  const snap=await getDocs(collection(db,'kas'));
  let total=0;
  snap.forEach(d=>{
    const k=d.data();
    total += (k.tipe==='masuk'?1:-1)*(k.jumlah||0);
  });
  $('#kasTotal').textContent = "Rp " + total.toLocaleString('id-ID');
})();
</script>
</body>
</html>
