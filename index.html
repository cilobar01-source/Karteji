<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portal KARTEJI Cilosari Barat RT01/RW08</title>
  <link rel="stylesheet" href="style.css" />
  
  <!-- ==== PWA META & MANIFEST ==== -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0e4c92" />
  <meta name="background-color" content="#0b132b" />
  <link rel="apple-touch-icon" sizes="192x192" href="assets/icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="KARTEJI Portal" />
  <meta name="mobile-web-app-capable" content="yes" />
</head>

<body>
  <header>
    <div class="logo">
      <img src="assets/logo.svg" alt="KARTEJI" height="42" />
      <h1>KARTEJI Portal</h1>
    </div>
    <nav>
      <a href="#pengumuman">Pengumuman</a>
      <a href="#berita">Berita</a>
      <a href="#umkm">Produk</a>
      <a href="#kas">Kas</a>
      <button id="loginBtn" class="btn btn-primary" onclick="location.href='auth.html'">Masuk / Daftar</button>
      <button id="dashBtn" class="btn btn-ghost" onclick="location.href='dashboard.html'">Dashboard</button>
    </nav>
  </header>

  <main>
    <section class="hero">
      <h2>Selamat Datang di Portal Karang Taruna Cilosari Barat</h2>
      <p>RT01 / RW08 • Kelurahan Kemijen • Semarang Timur</p>
    </section>

    <section id="pengumuman" class="container">
      <h2>📢 Pengumuman</h2>
      <div id="pengumumanList" class="grid"></div>
    </section>

    <section id="berita" class="container">
      <h2>📰 Berita</h2>
      <div id="beritaList" class="grid"></div>
    </section>

    <section id="umkm" class="container">
      <h2>🏪 Produk Warga</h2>
      <div id="umkmList" class="grid"></div>
    </section>

    <section id="kas" class="container">
      <h2>💰 Ringkasan Kas</h2>
      <div class="card">
        <div id="kasTotal">Rp 0</div>
        <p class="note">Detail transaksi tersedia untuk anggota di Dashboard.</p>
      </div>
    </section>
  </main>

  <footer>
    <p>© 2025 Karang Taruna Cilosari Barat RT01/RW08</p>
  </footer>

  <!-- ==== Firebase Fetch Data ==== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, collection, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCgJC8OQBG_wQt57tZHfNuVKPb2VVlAalI",
      authDomain: "karang-taruna-aadaf.firebaseapp.com",
      projectId: "karang-taruna-aadaf",
      storageBucket: "karang-taruna-aadaf.appspot.com",
      messagingSenderId: "367208001887",
      appId: "1:367208001887:web:bce5982d99edefb7e746ea"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const q = (id) => document.getElementById(id);

    async function loadPengumuman() {
      const snap = await getDocs(query(collection(db, "pengumuman"), orderBy("createdAt", "desc")));
      const html = snap.docs.map(d => {
        const p = d.data();
        return `<div class="card"><h3>${p.judul}</h3><p>${(p.isi || '').slice(0,120)}...</p></div>`;
      }).join("");
      q("pengumumanList").innerHTML = html || "<p>Belum ada pengumuman.</p>";
    }

    async function loadBerita() {
      const snap = await getDocs(query(collection(db, "berita"), orderBy("createdAt", "desc")));
      const html = snap.docs.map(d => {
        const b = d.data();
        return `<div class="card"><h3>${b.judul}</h3><p>${(b.isi || '').slice(0,100)}...</p></div>`;
      }).join("");
      q("beritaList").innerHTML = html || "<p>Belum ada berita.</p>";
    }

    async function loadUMKM() {
      const snap = await getDocs(query(collection(db, "umkm"), orderBy("createdAt", "desc")));
      const html = snap.docs.map(d => {
        const u = d.data();
        return `<div class="card"><h3>${u.produk}</h3><p>👤 ${u.penjual} • 💰 Rp${u.harga}</p></div>`;
      }).join("");
      q("umkmList").innerHTML = html || "<p>Belum ada produk.</p>";
    }

    async function loadKas() {
      const snap = await getDocs(collection(db, "kas"));
      let total = 0;
      snap.forEach(doc => {
        const k = doc.data();
        total += (k.tipe === "masuk" ? 1 : -1) * (k.jumlah || 0);
      });
      q("kasTotal").innerText = "Rp " + total.toLocaleString();
    }

    onAuthStateChanged(auth, (user) => {
      const loginBtn = q("loginBtn");
      const dashBtn = q("dashBtn");
      if (user) {
        loginBtn.style.display = "none";
        dashBtn.style.display = "inline-block";
      } else {
        dashBtn.style.display = "none";
        loginBtn.style.display = "inline-block";
      }
    });

    loadPengumuman();
    loadBerita();
    loadUMKM();
    loadKas();
  </script>

  <!-- ==== REGISTER SERVICE WORKER ==== -->
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js").then(() => console.log("SW ready."));
  }
  </script>
</body>
</html>
