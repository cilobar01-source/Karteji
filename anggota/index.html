<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard Anggota â€¢ Karang Taruna</title>
<link rel="stylesheet" href="../css/style.css">
<link rel="manifest" href="../manifest.webmanifest">
<meta name="theme-color" content="#000000">
</head>
<body>
<header class="header-glass">
  <div class="header-title">
    <img src="../assets/icons/kt.svg" width="36" height="36">
    <div>Dashboard Anggota</div>
  </div>
  <button id="btnLogout" class="btn-glass" style="margin-right:1rem;">Keluar</button>
</header>

<main class="container" style="max-width:800px;">
  <section class="card-glass" style="margin-top:1rem;">
    <h2 id="welcome">Halo, Anggota!</h2>
    <p id="unitName"></p>
  </section>

  <section class="card-glass" style="margin-top:1rem;">
    <h3>ðŸ“¢ Pengumuman</h3>
    <ul id="forumList"></ul>
  </section>

  <section class="card-glass" style="margin-top:1rem;">
    <h3>ðŸŽ‰ Kegiatan Terbaru</h3>
    <ul id="eventList"></ul>
  </section>

  <section class="card-glass" style="margin-top:1rem;">
    <h3>ðŸ’° Kas / Iuran</h3>
    <ul id="kasList"></ul>
  </section>
</main>

<script type="module">
import { auth, db } from "../js/firebase.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getUnitID } from "../js/config.js";

const $ = (id)=>document.getElementById(id);

// logout
$("btnLogout").onclick = async()=>{
  await signOut(auth);
  location.href="/auth/portal_auth.html";
};

onAuthStateChanged(auth, async(user)=>{
  if(!user){ location.href="/auth/portal_auth.html"; return; }

  // ambil profil user
  const snap = await (await import("https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js")).getDoc(
    (await import("https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js")).doc(db, "users", user.uid)
  );
  const profil = snap.data();
  if(!profil || profil.status!=="approved"){
    alert("ðŸš« Akun belum diverifikasi pengurus.");
    await signOut(auth);
    location.href="/auth/portal_auth.html";
    return;
  }

  $("welcome").textContent = `Halo, ${profil.nama}!`;
  $("unitName").textContent = `Karang Taruna: ${profil.id_katar.replaceAll("_"," ").toUpperCase()}`;

  // ambil pengumuman
  const forumQ = query(collection(db,"forum"), where("id_katar","==",profil.id_katar), orderBy("dibuat","desc"));
  const forumSnap = await getDocs(forumQ);
  forumSnap.forEach(d=>{
    $("forumList").innerHTML += `<li>${d.data().judul || "Tanpa Judul"} - ${new Date(d.data().dibuat).toLocaleDateString("id-ID")}</li>`;
  });

  // ambil kegiatan
  const kegQ = query(collection(db,"kegiatan"), where("id_katar","==",profil.id_katar), orderBy("dibuat","desc"));
  const kegSnap = await getDocs(kegQ);
  kegSnap.forEach(d=>{
    $("eventList").innerHTML += `<li>${d.data().nama || "Tanpa Nama"} - ${new Date(d.data().tanggal).toLocaleDateString("id-ID")}</li>`;
  });

  // ambil kas publik
  const kasQ = query(collection(db,"kas"), where("id_katar","==",profil.id_katar), orderBy("dibuat","desc"));
  const kasSnap = await getDocs(kasQ);
  kasSnap.forEach(d=>{
    const dt=d.data();
    $("kasList").innerHTML += `<li>${dt.keterangan || "Tanpa keterangan"} â€” Rp ${dt.nominal?.toLocaleString("id-ID")}</li>`;
  });
});
</script>
</body>
</html>
