<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" href="assets/logo.svg"><link rel="stylesheet" href="css/style.css">
<title>Dashboard • KARTEJI</title>
</head>
<body>
<header class="card" style="border-radius:0">
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:1rem;">
    <div class="brand">
      <img src="assets/logo.svg" alt="logo">
      <div class="brand-title">Dashboard Karang Taruna</div>
    </div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <button id="btnLogout" class="btn btn-ghost">Keluar</button>
    </nav>
  </div>
</header>

<main class="container" style="display:grid;grid-template-columns:240px 1fr;gap:1rem">
  <aside class="card" style="height:max-content">
    <div class="pad">
      <div class="badge" id="userEmail">-</div>
      <div style="margin-top:.6rem;font-weight:800">Menu</div>
      <div id="sideMenu" style="display:flex;flex-direction:column;gap:.4rem;margin-top:.4rem"></div>
    </div>
  </aside>

  <section id="content">
    <!-- PROFIL -->
    <div id="panel-profil" class="card"><div class="pad">
      <h3 class="section-title">👤 Profil Saya</h3>
      <input id="pNama" placeholder="Nama lengkap">
      <input id="pFoto" type="file" accept="image/*" multiple>
      <button class="btn btn-primary" id="pSimpan">Simpan Profil</button>
      <p class="note">Foto profil mendukung multi-gambar (disimpan sebagai array URL Cloudinary).</p>
      <div id="pGaleri" class="grid grid-3" style="margin-top:.8rem"></div>
    </div></div>

    <!-- ANGGOTA (super_admin: ubah role) -->
    <div id="panel-anggota" class="card" style="display:none"><div class="pad">
      <h3 class="section-title">👥 Anggota</h3>
      <div id="anggotaList" class="grid grid-2"></div>
    </div></div>

    <!-- PENGUMUMAN -->
    <div id="panel-pengumuman" class="card" style="display:none"><div class="pad">
      <h3 class="section-title">📢 Pengumuman</h3>
      <input id="gJudul" placeholder="Judul">
      <textarea id="gIsi" placeholder="Isi pengumuman" rows="4"></textarea>
      <input id="gTanggal" type="date">
      <button class="btn btn-primary" id="gSimpan">Simpan</button>
      <div id="pengList" class="grid grid-2" style="margin-top:1rem"></div>
    </div></div>

    <!-- BERITA -->
    <div id="panel-berita" class="card" style="display:none"><div class="pad">
      <h3 class="section-title">📰 Berita</h3>
      <input id="bJudul" placeholder="Judul">
      <textarea id="bIsi" placeholder="Isi berita" rows="5"></textarea>
      <input id="bFoto" type="file" accept="image/*" multiple>
      <button class="btn btn-primary" id="bSimpan">Simpan</button>
      <div id="beritaList" class="grid grid-2" style="margin-top:1rem"></div>
    </div></div>

    <!-- UMKM / Produk -->
    <div id="panel-umkm" class="card" style="display:none"><div class="pad">
      <h3 class="section-title">🏪 Produk</h3>
      <input id="uProduk" placeholder="Nama produk">
      <input id="uPenjual" placeholder="Nama penjual">
      <input id="uHarga" type="number" placeholder="Harga (Rp)">
      <input id="uWa" placeholder="Nomor WhatsApp (628xxxx)">
      <textarea id="uDes" placeholder="Deskripsi" rows="3"></textarea>
      <input id="uFoto" type="file" accept="image/*" multiple>
      <button class="btn btn-primary" id="uSimpan">Simpan</button>
      <div id="umkmList" class="grid grid-2" style="margin-top:1rem"></div>
    </div></div>

    <!-- KAS -->
    <div id="panel-kas" class="card" style="display:none"><div class="pad">
      <h3 class="section-title">💰 Kas</h3>
      <input id="kNama" placeholder="Nama pembayar">
      <input id="kTanggal" type="date">
      <input id="kJumlah" type="number" placeholder="Jumlah (Rp)">
      <select id="kTipe"><option value="masuk">Pemasukan</option><option value="keluar">Pengeluaran</option></select>
      <input id="kKet" placeholder="Keterangan">
      <button class="btn btn-primary" id="kSimpan">Simpan</button>
      <div id="kasList" style="margin-top:1rem"></div>
    </div></div>

  </section>
</main>

<footer>© 2025 KARTEJI</footer>

<script type="module">
import { auth, db } from './js/firebase.js';
import { onAuth, logout } from './js/auth.js';
import { uploadToCloudinary } from './js/cloudinary.js';
import { $, $$, fmtRupiah, nl2br } from './js/utils.js';
import {
  doc, getDoc, setDoc, updateDoc, deleteDoc,
  collection, addDoc, getDocs, orderBy, query, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

/* ===== Auth guard ===== */
let UID=null, ROLE='anggota', EMAIL='';
onAuth(async (u)=>{
  if(!u){ alert('Silakan login dulu'); location.href='login.html'; return; }
  UID=u.uid; EMAIL=u.email;
  $('#userEmail').textContent = EMAIL;
  const usnap = await getDoc(doc(db,'users',UID));
  const udata = usnap.exists()? usnap.data() : {};
  ROLE = udata.role || 'anggota';
  renderSidebarByRole();
  loadProfil();
  if(can('pengumuman')) loadPengumuman();
  if(can('berita')) loadBerita();
  if(can('umkm')) loadUmkm();
  if(can('kas')) loadKas();
  if(can('anggota')) loadAnggota();
});

$('#btnLogout').onclick = async()=>{ await logout(); location.href='index.html'; };

/* ===== Role map ===== */
const roleMap = {
  super_admin: ['profil','anggota','pengumuman','berita','umkm','kas'],
  admin:       ['profil','pengumuman','berita','umkm','kas'],
  admin_pengumuman:['profil','pengumuman'],
  admin_berita:['profil','berita'],
  admin_umkm:['profil','umkm'],
  admin_keuangan:['profil','kas'],
  anggota:['profil']
};
function can(area){
  if(ROLE==='super_admin') return true;
  switch(area){
    case 'anggota': return ROLE==='super_admin';
    case 'pengumuman': return ['admin','admin_pengumuman'].includes(ROLE);
    case 'berita': return ['admin','admin_berita'].includes(ROLE);
    case 'umkm': return ['admin','admin_umkm'].includes(ROLE);
    case 'kas': return ['admin','admin_keuangan'].includes(ROLE);
    default: return true;
  }
}
function renderSidebarByRole(){
  const menu = roleMap[ROLE] || ['profil'];
  const wrap = $('#sideMenu');
  wrap.innerHTML = '';
  menu.forEach((id,i)=>{
    const a=document.createElement('a');
    a.href="#"; a.textContent=id.toUpperCase();
    a.className="btn btn-ghost";
    a.onclick=(e)=>{e.preventDefault(); showPanel(id);};
    wrap.appendChild(a);
    if(i===0) showPanel(id);
  });
}
function showPanel(id){
  ['profil','anggota','pengumuman','berita','umkm','kas'].forEach(pid=>{
    const el = document.getElementById('panel-'+pid);
    if(el) el.style.display = (pid===id ? 'block':'none');
  });
}

/* ===== PROFIL ===== */
async function loadProfil(){
  const us = await getDoc(doc(db,'users',UID));
  const d  = us.exists()? us.data() : {};
  $('#pNama').value = d.nama||'';
  renderGaleri(d.foto);
}
function renderGaleri(fotos){
  const g = $('#pGaleri'); g.innerHTML='';
  const arr = Array.isArray(fotos)? fotos : (fotos?[fotos]:[]);
  arr.forEach(url=>{
    const el=document.createElement('img');
    el.src=url; el.className='thumb'; g.appendChild(el);
  });
}
$('#pSimpan').onclick = async()=>{
  const nama = $('#pNama').value.trim();
  const files = $('#pFoto').files;
  let fotoUrls = [];
  if(files && files.length>0){
    fotoUrls = await uploadToCloudinary(files);
  }
  await setDoc(doc(db,'users',UID), {
    ...(nama && { nama }),
    ...(fotoUrls.length>0 && { foto: fotoUrls })
  }, { merge:true });
  alert('Profil tersimpan.');
  loadProfil();
};

/* ===== ANGGOTA ===== */
async function loadAnggota(){
  const c=$('#anggotaList'); c.innerHTML='Memuat...';
  const snap=await getDocs(query(collection(db,'users'), orderBy('email')));
  c.innerHTML='';
  snap.forEach(u=>{
    const d=u.data(); const id=u.id;
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`
      <div class="pad">
        <div class="badge">${d.role||'anggota'}</div>
        <div style="font-weight:800;margin-top:.3rem">${d.nama||'(Tanpa nama)'}</div>
        <div class="note">${d.email||''}</div>
        ${ROLE==='super_admin'?`
        <select id="role-${id}" style="margin-top:.5rem">
          <option value="anggota" ${d.role==='anggota'?'selected':''}>anggota</option>
          <option value="admin" ${d.role==='admin'?'selected':''}>admin</option>
          <option value="admin_pengumuman" ${d.role==='admin_pengumuman'?'selected':''}>admin_pengumuman</option>
          <option value="admin_berita" ${d.role==='admin_berita'?'selected':''}>admin_berita</option>
          <option value="admin_umkm" ${d.role==='admin_umkm'?'selected':''}>admin_umkm</option>
          <option value="admin_keuangan" ${d.role==='admin_keuangan'?'selected':''}>admin_keuangan</option>
          <option value="super_admin" ${d.role==='super_admin'?'selected':''}>super_admin</option>
        </select>
        <div style="display:flex;gap:.5rem;margin-top:.5rem">
          <button class="btn btn-primary" data-act="save" data-id="${id}">Simpan</button>
          <button class="btn btn-ghost" data-act="disable" data-id="${id}">Nonaktifkan</button>
        </div>`:''}
      </div>`;
    c.appendChild(card);
  });

  if(ROLE==='super_admin'){
    c.addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      const id=b.getAttribute('data-id'); const act=b.getAttribute('data-act');
      if(act==='save'){
        const r=document.getElementById(`role-${id}`).value;
        await setDoc(doc(db,'users',id), { role:r }, { merge:true });
        alert('Role diperbarui.');
        loadAnggota();
      } else if (act==='disable'){
        if(!confirm('Nonaktifkan user ini?')) return;
        await setDoc(doc(db,'users',id), { status:'inactive' }, { merge:true });
        loadAnggota();
      }
    }, { once:true });
  }
}

/* ===== PENGUMUMAN (CRUD) ===== */
async function loadPengumuman(){
  const c=$('#pengList'); c.innerHTML='Memuat...';
  const snap=await getDocs(query(collection(db,'pengumuman'), orderBy('createdAt','desc')));
  c.innerHTML='';
  snap.forEach(d=>{
    const p=d.data();
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`
      <div class="pad">
        <div class="badge">${p.tanggal||''}</div>
        <h4 style="margin:.4rem 0">${p.judul||'(Tanpa judul)'}</h4>
        <p style="white-space:pre-line">${nl2br(p.isi||'')}</p>
        <div style="display:flex;gap:.5rem;margin-top:.5rem">
          <button class="btn btn-primary" data-edit="${d.id}">Edit</button>
          <button class="btn btn-ghost" data-del="${d.id}">Hapus</button>
        </div>
      </div>`;
    c.appendChild(el);
  });

  c.onclick=async(e)=>{
    const id = e.target.getAttribute('data-edit') || e.target.getAttribute('data-del');
    if(!id) return;
    if(e.target.hasAttribute('data-edit')){
      const v=(await getDoc(doc(db,'pengumuman',id))).data()||{};
      $('#gJudul').value=v.judul||'';
      $('#gIsi').value=v.isi||'';
      $('#gTanggal').value=v.tanggal||'';
      $('#gSimpan').setAttribute('data-editing', id);
      window.scrollTo({top:0,behavior:'smooth'});
    } else {
      if(!confirm('Hapus pengumuman?')) return;
      await deleteDoc(doc(db,'pengumuman',id));
      loadPengumuman();
    }
  };
}
$('#gSimpan').onclick = async ()=>{
  if(!can('pengumuman')) return alert('Akses ditolak.');
  const judul=$('#gJudul').value.trim();
  const isi=$('#gIsi').value.trim();
  const tanggal=$('#gTanggal').value||new Date().toISOString().slice(0,10);
  const editing = $('#gSimpan').getAttribute('data-editing');
  if(editing){
    await updateDoc(doc(db,'pengumuman',editing), { judul, isi, tanggal });
    $('#gSimpan').removeAttribute('data-editing');
  }else{
    await addDoc(collection(db,'pengumuman'), { judul, isi, tanggal, createdAt:serverTimestamp() });
  }
  $('#gJudul').value=''; $('#gIsi').value=''; $('#gTanggal').value='';
  loadPengumuman();
};

/* ===== BERITA (CRUD + multi gambar) ===== */
async function loadBerita(){
  const c=$('#beritaList'); c.innerHTML='Memuat...';
  const snap=await getDocs(query(collection(db,'berita'), orderBy('createdAt','desc')));
  c.innerHTML='';
  snap.forEach(d=>{
    const b=d.data(); const imgs=Array.isArray(b.foto)?b.foto:[b.foto].filter(Boolean);
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`
      ${imgs[0]?`<img class="thumb" src="${imgs[0]}" alt="">`:''}
      <div class="pad">
        <h4 style="margin:.4rem 0">${b.judul||'(Tanpa judul)'}</h4>
        <p style="white-space:pre-line">${nl2br(b.isi||'')}</p>
        <div style="display:flex;gap:.5rem;margin-top:.5rem">
          <button class="btn btn-primary" data-edit="${d.id}">Edit</button>
          <button class="btn btn-ghost" data-del="${d.id}">Hapus</button>
        </div>
      </div>`;
    c.appendChild(el);
  });

  c.onclick=async(e)=>{
    const id = e.target.getAttribute('data-edit') || e.target.getAttribute('data-del');
    if(!id) return;
    if(e.target.hasAttribute('data-edit')){
      const v=(await getDoc(doc(db,'berita',id))).data()||{};
      $('#bJudul').value=v.judul||'';
      $('#bIsi').value=v.isi||'';
      $('#bSimpan').setAttribute('data-editing', id);
      window.scrollTo({top:0,behavior:'smooth'});
    } else {
      if(!confirm('Hapus berita?')) return;
      await deleteDoc(doc(db,'berita',id));
      loadBerita();
    }
  };
}
$('#bSimpan').onclick = async ()=>{
  if(!can('berita')) return alert('Akses ditolak.');
  const judul=$('#bJudul').value.trim();
  const isi=$('#bIsi').value.trim();
  const files=$('#bFoto').files;
  let fotoUrls=[];
  if(files && files.length>0) fotoUrls = await uploadToCloudinary(files);
  const editing = $('#bSimpan').getAttribute('data-editing');
  if(editing){
    await updateDoc(doc(db,'berita',editing), {
      judul, isi, ...(fotoUrls.length>0 && { foto: fotoUrls })
    });
    $('#bSimpan').removeAttribute('data-editing');
  }else{
    await addDoc(collection(db,'berita'), {
      judul, isi, foto: fotoUrls, penulis: auth.currentUser?.email || 'anonim', createdAt: serverTimestamp()
    });
  }
  $('#bJudul').value=''; $('#bIsi').value=''; $('#bFoto').value='';
  loadBerita();
};

/* ===== UMKM / Produk (CRUD + multi gambar) ===== */
async function loadUmkm(){
  const c=$('#umkmList'); c.innerHTML='Memuat...';
  const snap=await getDocs(query(collection(db,'umkm'), orderBy('createdAt','desc')));
  c.innerHTML='';
  snap.forEach(d=>{
    const u=d.data(); const imgs=Array.isArray(u.foto)?u.foto:[u.foto].filter(Boolean);
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`
      ${imgs[0]?`<img class="thumb" src="${imgs[0]}" alt="">`:''}
      <div class="pad">
        <h4 style="margin:.4rem 0">${u.produk||'(Produk)'}</h4>
        <p>👤 ${u.penjual||'-'} • 💰 ${fmtRupiah(u.harga||0)}</p>
        <p style="white-space:pre-line">${nl2br(u.deskripsi||'')}</p>
        ${u.wa?`<a class="btn btn-primary" target="_blank" href="https://wa.me/${u.wa}">WhatsApp</a>`:''}
        <div style="display:flex;gap:.5rem;margin-top:.5rem">
          <button class="btn btn-primary" data-edit="${d.id}">Edit</button>
          <button class="btn btn-ghost" data-del="${d.id}">Hapus</button>
        </div>
      </div>`;
    c.appendChild(el);
  });

  c.onclick=async(e)=>{
    const id = e.target.getAttribute('data-edit') || e.target.getAttribute('data-del');
    if(!id) return;
    if(e.target.hasAttribute('data-edit')){
      const v=(await getDoc(doc(db,'umkm',id))).data()||{};
      $('#uProduk').value=v.produk||'';
      $('#uPenjual').value=v.penjual||'';
      $('#uHarga').value=v.harga||'';
      $('#uWa').value=v.wa||'';
      $('#uDes').value=v.deskripsi||'';
      $('#uSimpan').setAttribute('data-editing', id);
      window.scrollTo({top:0,behavior:'smooth'});
    } else {
      if(!confirm('Hapus produk ini?')) return;
      await deleteDoc(doc(db,'umkm',id));
      loadUmkm();
    }
  };
}
$('#uSimpan').onclick = async ()=>{
  if(!can('umkm')) return alert('Akses ditolak.');
  const produk=$('#uProduk').value.trim();
  const penjual=$('#uPenjual').value.trim();
  const harga=Number($('#uHarga').value||0);
  const wa=$('#uWa').value.trim();
  const des=$('#uDes').value.trim();
  const files=$('#uFoto').files;
  let fotoUrls=[];
  if(files && files.length>0) fotoUrls = await uploadToCloudinary(files);
  const editing = $('#uSimpan').getAttribute('data-editing');
  if(editing){
    await updateDoc(doc(db,'umkm',editing), {
      produk, penjual, harga, wa, deskripsi:des, ...(fotoUrls.length>0 && { foto: fotoUrls })
    });
    $('#uSimpan').removeAttribute('data-editing');
  }else{
    await addDoc(collection(db,'umkm'), {
      produk, penjual, harga, wa, deskripsi:des, foto: fotoUrls, createdAt: serverTimestamp()
    });
  }
  $('#uProduk').value=''; $('#uPenjual').value=''; $('#uHarga').value=''; $('#uWa').value=''; $('#uDes').value=''; $('#uFoto').value='';
  loadUmkm();
};

/* ===== KAS (CRUD) ===== */
async function loadKas(){
  const c=$('#kasList'); c.innerHTML='';
  const snap=await getDocs(query(collection(db,'kas'), orderBy('createdAt','desc')));
  let total=0;
  snap.forEach(d=>{
    const k=d.data();
    total += (k.tipe==='masuk'?1:-1)*(k.jumlah||0);
    const el=document.createElement('div'); el.className='card';
    el.innerHTML=`<div class="pad">
      <div class="badge">${k.tipe==='masuk'?'Pemasukan':'Pengeluaran'}</div>
      <div style="font-weight:800;margin-top:.3rem">${fmtRupiah(k.jumlah||0)}</div>
      <div class="note">👤 ${k.nama||'-'} • 📅 ${k.tanggal||''}</div>
      <div>${k.keterangan||''}</div>
      <div style="display:flex;gap:.5rem;margin-top:.5rem">
        <button class="btn btn-ghost" data-del="${d.id}">Hapus</button>
      </div>
    </div>`;
    c.appendChild(el);
  });
  const sum=document.createElement('div'); sum.className='card';
  sum.innerHTML=`<div class="pad"><h4 style="margin:0">Total Kas: ${fmtRupiah(total)}</h4></div>`;
  c.prepend(sum);

  c.onclick = async(e)=>{
    const id=e.target.getAttribute('data-del');
    if(!id) return;
    if(!can('kas')) return alert('Akses ditolak.');
    if(!confirm('Hapus transaksi ini?')) return;
    await deleteDoc(doc(db,'kas',id)); loadKas();
  };
}
$('#kSimpan').onclick = async ()=>{
  if(!can('kas')) return alert('Akses ditolak.');
  const nama=$('#kNama').value.trim();
  const tanggal=$('#kTanggal').value||new Date().toISOString().slice(0,10);
  const jumlah=Number($('#kJumlah').value||0);
  const tipe=$('#kTipe').value;
  const ket=$('#kKet').value.trim();
  if(!nama || !jumlah) return alert('Isi nama & jumlah.');
  await addDoc(collection(db,'kas'), { nama, tanggal, jumlah, tipe, keterangan:ket, createdAt: serverTimestamp() });
  $('#kNama').value=''; $('#kJumlah').value=''; $('#kKet').value='';
  loadKas();
};
</script>
</body>
</html>
