<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Portal Karang Taruna • Auth</title>
<link rel="stylesheet" href="../css/style.css">
</head>
<body>
<header class="header-glass">
  <div class="header-title">
    <img src="../assets/icons/kt.svg" width="36" height="36">
    <div>Portal Karang Taruna</div>
  </div>
</header>

<main class="container" style="max-width:540px;">
  <div class="card-glass">
    <div style="display:flex;gap:6px;margin-bottom:10px;">
      <button class="btn-glass" id="tabKatar" style="flex:1;background:rgba(255,255,255,.15)">Karang Taruna</button>
      <button class="btn-glass" id="tabAnggota" style="flex:1;">Anggota</button>
    </div>

    <!-- === KARANG TARUNA FORM === -->
    <div id="formKatar">
      <h3>Masuk / Daftar Karang Taruna</h3>
      <div class="input-wrap"><label>Email</label><input id="katarEmail" type="email"></div>
      <div class="input-wrap"><label>Password</label><input id="katarPass" type="password"></div>
      <div style="margin-top:10px;display:flex;gap:6px;">
        <button id="btnKatarLogin" class="btn-glass" style="flex:1;">Masuk</button>
        <button id="btnKatarReg" class="btn-glass" style="flex:1;">Daftar</button>
      </div>
      <a href="#" id="forgotKatar" class="info-chip">Lupa Password?</a>

      <div id="regKatar" style="display:none;margin-top:16px;">
        <div class="input-wrap"><label>Nama Karang Taruna</label><input id="namaKatar" type="text"></div>
        <div class="input-wrap"><label>ID Unik</label><input id="idKatar" type="text" placeholder="contoh: cilosari_barat"></div>
        <button id="btnKatarSubmit" class="btn-glass">Buat Karang Taruna</button>
      </div>
    </div>

    <!-- === ANGGOTA FORM === -->
    <div id="formAnggota" style="display:none;">
      <h3>Masuk / Daftar Anggota</h3>
      <div class="input-wrap"><label>Email</label><input id="angEmail" type="email"></div>
      <div class="input-wrap"><label>Password</label><input id="angPass" type="password"></div>
      <div style="margin-top:10px;display:flex;gap:6px;">
        <button id="btnAngLogin" class="btn-glass" style="flex:1;">Masuk</button>
        <button id="btnAngReg" class="btn-glass" style="flex:1;">Daftar</button>
      </div>
      <a href="#" id="forgotAng" class="info-chip">Lupa Password?</a>

      <div id="regAng" style="display:none;margin-top:16px;">
        <div class="input-wrap"><label>Nama</label><input id="namaAng" type="text"></div>
        <div class="input-wrap"><label>Pilih Karang Taruna</label><select id="unitList"></select></div>
        <button id="btnAngSubmit" class="btn-glass">Daftar Anggota</button>
      </div>
    </div>
  </div>

  <p class="footer-note">v7.7 • Unified Auth + Verification System</p>
</main>

<script type="module">
import { auth, db } from "../js/firebase.js";
import { createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
import { doc, setDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const $=(id)=>document.getElementById(id);
$("tabKatar").onclick=()=>{ $("formKatar").style.display="block"; $("formAnggota").style.display="none"; $("tabKatar").style.background="rgba(255,255,255,.15)"; $("tabAnggota").style.background="transparent"; };
$("tabAnggota").onclick=()=>{ $("formKatar").style.display="none"; $("formAnggota").style.display="block"; $("tabKatar").style.background="transparent"; $("tabAnggota").style.background="rgba(255,255,255,.15)"; };

// === LOGIN KARANG TARUNA ===
$("btnKatarLogin").onclick=async()=>{
  try{
    const c=await signInWithEmailAndPassword(auth,$("katarEmail").value,$("katarPass").value);
    alert("✅ Login berhasil!");
    location.href="/index.html";
  }catch(e){alert("❌ "+e.message);}
};

// === REGISTER KARANG TARUNA BARU ===
$("btnKatarReg").onclick=()=>{$("regKatar").style.display=$("regKatar").style.display=="none"?"block":"none";}
$("btnKatarSubmit").onclick=async()=>{
  try{
    const email=$("katarEmail").value, pass=$("katarPass").value, nama=$("namaKatar").value, id=$("idKatar").value.toLowerCase();
    const u=await createUserWithEmailAndPassword(auth,email,pass);
    await setDoc(doc(db,"users",u.user.uid),{email,nama:"Ketua",role:"super_admin",id_katar:id,status:"approved",dibuat:Date.now()});
    await setDoc(doc(db,"karangtaruna",id),{nama,dibuat:Date.now()});
    alert("🎉 Karang Taruna dibuat!");
    location.href="/index.html";
  }catch(e){alert("❌ "+e.message);}
};

// === LUPA PASSWORD KARANG TARUNA ===
$("forgotKatar").onclick=async()=>{
  const email=prompt("Masukkan email Karang Taruna:");
  if(!email)return;
  await sendPasswordResetEmail(auth,email);
  alert("📩 Email reset terkirim!");
};

// === LOGIN ANGGOTA ===
$("btnAngLogin").onclick=async()=>{
  try{
    const c=await signInWithEmailAndPassword(auth,$("angEmail").value,$("angPass").value);
    const snap=await (await import("https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js")).getDoc(doc(db,"users",c.user.uid));
    if(snap.exists() && snap.data().status!=="approved"){
      alert("🚫 Akun Anda belum diverifikasi pengurus.");
      await auth.signOut();
      return;
    }
    alert("✅ Login berhasil!");
    location.href="/anggota/index.html";
  }catch(e){alert("❌ "+e.message);}
};

// === REGISTER ANGGOTA BARU ===
$("btnAngReg").onclick=()=>{$("regAng").style.display=$("regAng").style.display=="none"?"block":"none";}
$("btnAngSubmit").onclick=async()=>{
  try{
    const nama=$("namaAng").value,email=$("angEmail").value,pass=$("angPass").value,id_katar=$("unitList").value;
    const u=await createUserWithEmailAndPassword(auth,email,pass);
    await setDoc(doc(db,"users",u.user.uid),{nama,email,role:"anggota",id_katar,status:"pending",dibuat:Date.now()});
    alert("📨 Terdaftar! Tunggu verifikasi pengurus.");
    location.href="/auth/index.html";
  }catch(e){alert("❌ "+e.message);}
};

// === LUPA PASSWORD ANGGOTA ===
$("forgotAng").onclick=async()=>{
  const email=prompt("Masukkan email Anda:");
  if(!email)return;
  await sendPasswordResetEmail(auth,email);
  alert("📩 Email reset terkirim!");
};

// === AMBIL DAFTAR UNIT ===
(async()=>{
  const q=await getDocs(collection(db,"karangtaruna"));
  $("unitList").innerHTML=q.docs.map(d=>`<option value="${d.id}">${d.data().nama}</option>`).join("");
})();
</script>
</body>
</html>
