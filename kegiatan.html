<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kegiatan ‚Ä¢ KARTEJI</title>
<link rel="icon" href="assets/logo.svg" />
<style>
:root{
  --biru:#0e4c92;--emas:#f6c445;--bg:#0b132b;--text:#f5f7fa;--card:#111928;
}
body.light{--bg:#f5f7fa;--text:#1e293b;--card:#fff;}
*{box-sizing:border-box;}
body{margin:0;font-family:'Poppins',system-ui;background:var(--bg);color:var(--text);}
a{text-decoration:none;color:inherit;}
header{display:flex;justify-content:space-between;align-items:center;padding:.9rem 1.2rem;background:var(--card);
  border-bottom:1px solid rgba(255,255,255,.1);position:sticky;top:0;z-index:10;}
header b{font-size:1.1rem;}
.container{max-width:800px;margin:auto;padding:1.2rem;}
h1{color:var(--emas);}
img{max-width:100%;border-radius:10px;margin:.6rem 0;}
.meta{color:rgba(255,255,255,.6);font-size:.9rem;margin-bottom:1rem;}
body.light .meta{color:#64748b;}
button{padding:.6rem 1.1rem;border:none;border-radius:8px;font-weight:700;cursor:pointer;}
.btn-primary{background:var(--emas);color:#0b132b;transition:.2s;}
.btn-primary:disabled{opacity:.7;cursor:not-allowed;}
.btn-outline{background:transparent;border:1px solid var(--emas);color:var(--emas);}
footer{text-align:center;padding:2rem 1rem;border-top:1px solid rgba(255,255,255,.1);margin-top:2rem;}
.hidden{display:none;}
.notice{margin-top:1rem;padding:.8rem;border-radius:8px;background:rgba(246,196,69,.1);border:1px solid var(--emas);}
.peserta-list{margin-top:1rem;font-size:.9rem;}
.badge-box{margin-bottom:1rem;padding:.8rem;border:1px solid var(--emas);border-radius:10px;
  background:rgba(246,196,69,.05);text-align:center;}
.badge-box span{display:block;font-size:1.4rem;}
.loader{display:inline-block;width:14px;height:14px;border:2px solid var(--emas);border-radius:50%;border-top-color:transparent;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<header>
  <b>üí™ Kegiatan KARTEJI</b>
  <div>
    <button id="themeBtn" class="btn-outline">üåì</button>
    <a href="index.html" class="btn-outline">‚Ü©Ô∏è Kembali</a>
  </div>
</header>

<div class="container">
  <div id="userBadge" class="badge-box hidden"></div>

  <h1 id="judul">Memuat...</h1>
  <div id="meta" class="meta"></div>
  <img id="foto" class="hidden" alt="Banner kegiatan" />
  <p id="deskripsi"></p>

  <button id="ikutBtn" class="btn-primary hidden">‚ú® Ikut Kegiatan Ini</button>
  <div id="notifikasi" class="notice hidden"></div>

  <div id="pesertaSection" class="hidden">
    <h3 style="color:var(--emas)">üë• Peserta Terdaftar</h3>
    <div id="daftarPeserta" class="peserta-list"></div>
  </div>
</div>

<footer>
  <p>¬© 2025 KARTEJI Cilosari Barat</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { 
  getFirestore, doc, getDoc, collection, addDoc, getDocs, query, orderBy, updateDoc, setDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { 
  getAuth, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCgJC8OQBG_wQt57tZHfNuVKPb2VVlAalI",
  authDomain: "karang-taruna-aadaf.firebaseapp.com",
  projectId: "karang-taruna-aadaf",
  storageBucket: "karang-taruna-aadaf.appspot.com",
  messagingSenderId: "367208001887",
  appId: "1:367208001887:web:bce5982d99edefb7e746ea"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const params = new URLSearchParams(location.search);
const id = params.get("id");
const $ = s => document.querySelector(s);
$('#themeBtn').onclick = ()=>document.body.classList.toggle('light');

let currentUser = null;

// ==== BADGE LOGIC ====
function hitungBadge(poin){
  if(poin >= 250) return {nama:"Inspiratif",icon:"üëë"};
  if(poin >= 100) return {nama:"Aktif",icon:"üî•"};
  return {nama:"Pemula",icon:"üê£"};
}

// === LOAD DETAIL KEGIATAN ===
async function loadKegiatan(){
  const ref = doc(db,'kegiatan',id);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    $('#judul').textContent="Kegiatan tidak ditemukan";
    return;
  }
  const k = snap.data();
  $('#judul').textContent = k.judul || '(Tanpa Judul)';
  $('#meta').innerHTML = `üìÖ ${k.tanggal || '-'} ¬∑ ${k.tipe || ''}`;
  $('#deskripsi').innerHTML = (k.deskripsi || '').replace(/\n/g,'<br>');
  if(k.foto){
    $('#foto').src = Array.isArray(k.foto)?k.foto[0]:k.foto;
    $('#foto').classList.remove('hidden');
  }
  loadPeserta();
}

// === LOAD PESERTA ===
async function loadPeserta(){
  const qy = query(collection(db,'kegiatan',id,'peserta'),orderBy('createdAt','desc'));
  const snap = await getDocs(qy);
  const c = $('#daftarPeserta');
  c.innerHTML='';
  if(snap.empty){
    c.innerHTML='<p class="meta">Belum ada peserta.</p>';
    return;
  }
  snap.forEach(d=>{
    const p=d.data();
    const el=document.createElement('div');
    el.textContent=`‚Ä¢ ${p.nama || 'Anonim'} (${p.email || ''})`;
    c.appendChild(el);
  });
  $('#pesertaSection').classList.remove('hidden');
}

// === CEK APAKAH SUDAH TERDAFTAR ===
async function sudahTerdaftar(uid){
  const snap = await getDocs(collection(db,'kegiatan',id,'peserta'));
  let ada = false;
  snap.forEach(d=>{ if(d.data().uid === uid) ada=true; });
  return ada;
}

// === IKUT KEGIATAN + TAMBAH POIN + UPDATE BADGE ===
$('#ikutBtn').onclick = async ()=>{
  if(!currentUser) return;
  $('#ikutBtn').innerHTML = '<span class="loader"></span> Mendaftar...';
  $('#ikutBtn').disabled = true;

  await addDoc(collection(db,'kegiatan',id,'peserta'),{
    uid: currentUser.uid,
    nama: currentUser.displayName || currentUser.email,
    email: currentUser.email,
    createdAt: serverTimestamp()
  });

  const refUser = doc(db,'users',currentUser.uid);
  const snap = await getDoc(refUser);
  let poinBaru = 10, badgeNow = hitungBadge(poinBaru);
  if(snap.exists()){
    const data = snap.data();
    poinBaru = (data.poin || 0) + 10;
    badgeNow = hitungBadge(poinBaru);
    await updateDoc(refUser,{poin:poinBaru,badge:badgeNow.nama});
  }else{
    await setDoc(refUser,{
      nama: currentUser.displayName || currentUser.email,
      email: currentUser.email,
      poin: poinBaru,
      badge: badgeNow.nama
    });
  }

  $('#notifikasi').textContent=`‚úÖ Kamu berhasil mendaftar dan mendapat +10 poin! Lencana kamu: ${badgeNow.icon} ${badgeNow.nama}`;
  $('#notifikasi').classList.remove('hidden');
  $('#ikutBtn').textContent="‚úÖ Sudah Terdaftar";
  $('#ikutBtn').style.background="#4ade80";
  loadPeserta();
  tampilBadge(poinBaru,badgeNow.nama);
};

// === TAMPIL BADGE USER ===
function tampilBadge(poin,badge){
  $('#userBadge').innerHTML=`<span>${hitungBadge(poin).icon}</span>
    <b>${badge}</b><br>Poin: ${poin}`;
  $('#userBadge').classList.remove('hidden');
}

// === CEK LOGIN ===
onAuthStateChanged(auth, async (user)=>{
  currentUser=user;
  if(user){
    const refUser = doc(db,'users',user.uid);
    const snap = await getDoc(refUser);
    if(snap.exists()){
      const data = snap.data();
      tampilBadge(data.poin||0,data.badge||"Pemula");
    }
    const sudah = await sudahTerdaftar(user.uid);
    if(sudah){
      $('#ikutBtn').textContent="‚úÖ Sudah Terdaftar";
      $('#ikutBtn').disabled=true;
    }else{
      $('#ikutBtn').classList.remove('hidden');
    }
  } else {
    $('#notifikasi').textContent="Masuk terlebih dahulu untuk ikut kegiatan.";
    $('#notifikasi').classList.remove('hidden');
  }
  loadKegiatan();
});
</script>
</body>
</html>
